#
# Misc bash functions
#
function dependablast()
{
    git branch -r | awk -F/ '/\/dependabot/{print$2"/"$3"/"$4}' | xargs -I {} git push origin :{}
}


# pip bash completion start
if type complete > /dev/null; then
    _pip_completion()
    {
        COMPREPLY=( $( COMP_WORDS="${COMP_WORDS[*]}" \
                       COMP_CWORD=$COMP_CWORD \
                       PIP_AUTO_COMPLETE=1 $1 ) )
    }
    complete -o default -F _pip_completion pip
fi
# pip bash completion end

# Decrypt a file using DES3 symmetric encryption with PBKDF2 key derivation.
# You will be prompted to enter the password that was used to encrypt the file.
# USAGE: decrypt <encrypted_input> <decrypted_output>
decrypt()
{
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "USAGE: decrypt <input> <output>"
    else
        openssl des3 -d -salt -pbkdf2 -in $1 -out $2
    fi
}

# Encrypt a file using DES3 symmetric encryption with PBKDF2 key derivation.
# You will be prompted to enter and verify a password to encrypt the file.
# USAGE: encrypt <plaintext_input> <encrypted_output>
encrypt()
{
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "USAGE: encrypt <input> <output>"
    else
        openssl des3 -salt -pbkdf2 -in $1 -out $2
    fi
}

# Encrypt a file using RSA public key encryption (asymmetric).
# Uses your SSH public key (~/.ssh/id_rsa.pub) to encrypt.
# Only the holder of the private key can decrypt.
# Note: RSA can only encrypt small files (~190 bytes). For larger files, use encrypt_large_pub.
# USAGE: encrypt_pub <plaintext_input> <encrypted_output>
encrypt_pub()
{
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "USAGE: encrypt_pub <input> <output>"
    else
        ssh-keygen -f ~/.ssh/id_rsa.pub -e -m PKCS8 | openssl pkeyutl -encrypt -pubin -inkey /dev/stdin -pkeyopt rsa_padding_mode:pkcs1 -in $1 -out $2
    fi
}

# Decrypt a file using RSA private key decryption (asymmetric).
# Uses your SSH private key PEM copy (~/.ssh/id_rsa_pem) to decrypt.
# You may be prompted for your SSH key passphrase if the key is protected.
# To create the PEM copy: cp ~/.ssh/id_rsa ~/.ssh/id_rsa_pem && ssh-keygen -p -N "" -m pem -f ~/.ssh/id_rsa_pem -P ""
# USAGE: decrypt_priv <encrypted_input> <decrypted_output>
decrypt_priv()
{
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "USAGE: decrypt_priv <input> <output>"
    else
        openssl pkeyutl -decrypt -inkey ~/.ssh/id_rsa_pem -pkeyopt rsa_padding_mode:pkcs1 -in $1 -out $2
    fi
}

function convert_to_mp3
{
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "USAGE: convert_to_mp3 <input_file> <output_file.mp3>"
    else
        ffmpeg -i $1 -acodec mp3 $2
    fi
}

function pyg()
{
    if [ -z "$1" ]; then
        echo "USAGE: pyg <input>"
    else
        echo "Running: pygmentize -f rtf $1 | pbcopy"
        pygmentize -f rtf $1 | pbcopy
    fi
}

function png2gif
{
    ## TODO: Make -r <rate> an input value.
    if [ -z "$1" ]; then
        echo "USAGE: png2gif <Filename> -- provide filename without -x.png, "
        echo "     e.g. ToastFox-1.png, ToastFox-2.png --> png2gif ToastFox "
    else
        FILE_PATTERN="$1-%d.png";
        OUTPUT="$1.gif";
        ffmpeg -f image2 -i $FILE_PATTERN -vcodec copy tmp-video.mkv && \
        ffmpeg -i tmp-video.mkv -pix_fmt rgb24 -loop 0 -r 5 $OUTPUT;
        rm tmp-video.mkv
    fi
}

function jpg2gif
{
    # TODO: Make -r <rate> an input value.
    # TODO: figure out how to control speed :-/
    if [ -z "$1" ]; then
        echo "USAGE: jpg2gif <Filename> -- provide filename without -x.jpg, "
        echo "     e.g. ToastFox-1.jpg, ToastFox-2.jpg --> jpg2gif ToastFox "
    else
        FILE_PATTERN="$1-%d.jpg";
        OUTPUT="$1.gif";
        ffmpeg -f image2 -i $FILE_PATTERN -vcodec copy tmp-video.mkv && \
        ffmpeg -i tmp-video.mkv -pix_fmt rgb24 -loop 0 -r 20 -frames 6 -vframes 6 $OUTPUT;
        rm tmp-video.mkv
    fi
}


function timerequest
{
    # Use curl to TIME http requests.
    # Inspired by this: http://stackoverflow.com/a/22625150/182778

   FMT="
         http_code:  %{http_code}
     size_download:  %{size_download}
       size_header:  %{size_header}
    speed_download:  %{speed_download}\n
   time_namelookup:  %{time_namelookup}
      time_connect:  %{time_connect}
   time_appconnect:  %{time_appconnect}
  time_pretransfer:  %{time_pretransfer}
     time_redirect:  %{time_redirect}
time_starttransfer:  %{time_starttransfer}
                   ----------
        time_total:  %{time_total}
    "
    curl -w "$FMT" -o /dev/null -s $1
}


function fnd
{
    # find but with a syntax I can remember.
    if [ -z "$1" ]; then
        echo "USAGE: fnd <pattern>"
    else
        find . -name "$1" -print
    fi
}

# http://osxdaily.com/2013/12/27/fix-there-is-no-connected-camera-error-mac/
function fixCamera {
    sudo killall AppleCameraAssistant;
    sudo killall VDCAssistant;
}


# See: https://apple.stackexchange.com/a/366841/58762
# and: https://superuser.com/questions/647396/reload-mac-audio-drivers-without-rebooting
function fixAudio {
    sudo pkill coreaudiod;
}

# A Function to list all the python classes in a file
function listclasses()
{
    if [ -z "$1" ]; then
        F="models.py"
    else
        F="$1"
    fi
    cat $F | grep "^class " | sed "s/class //" | sed "s/(.*$//" | sort
}
alias listmodels=listclasses | grep -v Manager

# A little function to zip up the current directory contents into a .love file.
function loveit()
{
    if [ -z "$1" ]; then
        echo "USAGE: loveit <name>"
    else
        zip -9 -q -r $1.love .
    fi
}

# WSL: Open an explorer window in a WSL directory.
function start() {
  cmd.exe /C start "$(wslpath -wa $1)" /C bash
}

# ADO queries
# Usage:
# ado_repos BDI
# ado_repos AnotherProject
ado_repos() {
  local project="${1:?Project name required}"
  curl -u :$ADO_TOKEN "https://dev.azure.com/StifelFinancial/${project}/_apis/git/repositories?api-version=7.0" | jq -r '.value[].name'
}



